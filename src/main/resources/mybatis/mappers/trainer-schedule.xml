<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="trainerSchedule">

	<!-- 1) 트레이너 예약 리스트(하단 표) : 예약된 건만 + 총/수업/잔여 포함 -->
	<select id="selectTrainerBookings" parameterType="map" resultType="map">
	    <![CDATA[
	    SELECT
	      a.availability_id                           AS availabilityId,
	      DATE(a.available_datetime)                  AS workDate,
	      DATE_FORMAT(a.available_datetime,'%H:00')   AS hourLabel,
	      r.reservation_id                            AS reservationId,
	      u.user_name                                 AS memberName,
	      r.status                                    AS status,
	
	      (
	        SELECT p.total_sessions
	        FROM pt_contract p
	        WHERE p.member_id = r.member_id
	          AND p.trainer_id = a.trainer_id
	        ORDER BY p.created_at DESC
	        LIMIT 1
	      ) AS totalSessions,
	
	      (
	        SELECT COUNT(*)
	        FROM reservation r2
	        JOIN availability a2 ON a2.availability_id = r2.availability_id
	        WHERE r2.member_id = r.member_id
	          AND a2.trainer_id = a.trainer_id
	          AND r2.status IN ('BOOKED','COMPLETED')
	      ) AS completedCount,
	
	      GREATEST(
	        COALESCE((
	          SELECT p.total_sessions
	          FROM pt_contract p
	          WHERE p.member_id = r.member_id
	            AND p.trainer_id = a.trainer_id
	          ORDER BY p.created_at DESC
	          LIMIT 1
	        ), 0)
	        -
	        COALESCE((
	          SELECT COUNT(*)
	          FROM reservation r2
	          JOIN availability a2 ON a2.availability_id = r2.availability_id
	          WHERE r2.member_id = r.member_id
	            AND a2.trainer_id = a.trainer_id
	            AND r2.status IN ('BOOKED','COMPLETED')
	        ), 0)
	      , 0) AS remainingCount
	
	    FROM reservation r
	    JOIN availability a ON a.availability_id = r.availability_id
	    JOIN users u        ON u.user_id        = r.member_id
	    WHERE a.trainer_id = #{trainerId}
	      AND a.available_datetime >= #{start}
	      AND a.available_datetime <  #{end}
	      AND r.status IN ('BOOKED','COMPLETED')
	    ORDER BY a.available_datetime ASC
	    ]]>
	</select>

	<!-- 2) 근무칸 + 예약여부(달력/모달 공용) : 빈 슬롯 포함 -->
	<select id="selectTrainerSlotsWithStatus" parameterType="map" resultType="map">
	    <![CDATA[
	    SELECT
	      a.availability_id                           AS availabilityId,
	      a.trainer_id                                AS trainerId,
	      a.available_datetime                        AS startDt,
	      DATE(a.available_datetime)                  AS workDate,
	      DATE_FORMAT(a.available_datetime,'%H:00')   AS hourLabel,
	      CASE WHEN r.reservation_id IS NULL THEN 'AVAILABLE'
	           ELSE r.status END                      AS slotStatus,
	      r.reservation_id                            AS reservationId,
	      u.user_name                                 AS memberName
	    FROM availability a
	    LEFT JOIN reservation r ON r.availability_id = a.availability_id
	    LEFT JOIN users u        ON u.user_id        = r.member_id
	    WHERE a.trainer_id = #{trainerId}
	      AND a.available_datetime >= #{start}
	      AND a.available_datetime <  #{end}
	    ORDER BY a.available_datetime ASC
	    ]]>
	</select>

	<!-- 3) 특정 날짜 슬롯 + 예약여부(모달 시간 버튼) -->
	<select id="selectDaySlotsWithStatus" parameterType="map" resultType="map">
	    <![CDATA[
	    SELECT
	      a.availability_id                           AS availabilityId,
	      DATE_FORMAT(a.available_datetime,'%H:00')   AS hourLabel,
	      CASE WHEN r.reservation_id IS NULL THEN 'AVAILABLE'
	           ELSE r.status END                      AS slotStatus
	    FROM availability a
	    LEFT JOIN reservation r ON r.availability_id = a.availability_id
	    WHERE a.trainer_id = #{trainerId}
	      AND DATE(a.available_datetime) = #{workDate}
	    ORDER BY a.available_datetime ASC
	    ]]>
	</select>

	<!-- 4) 근무시간 등록(단건) -->
	<insert id="insertAvailability" parameterType="map" useGeneratedKeys="true" keyProperty="availabilityId">
	    <![CDATA[
	    INSERT IGNORE INTO availability (trainer_id, available_datetime)
	    VALUES (#{trainerId}, #{availableDatetime})
	    ]]>
	</insert>

	<!-- 5) 근무시간 등록(배치) -->
	<insert id="insertAvailabilityBatch" parameterType="map">
	    <![CDATA[
	    INSERT IGNORE INTO availability (trainer_id, available_datetime)
	    VALUES
	    ]]>
			<foreach collection="datetimes" item="dt" separator=",">
	      <![CDATA[(#{trainerId}, #{dt})]]>
			</foreach>
	</insert>

	<!-- 6) 근무시간 삭제(단건) -->
	<delete id="deleteAvailabilityById" parameterType="map">
	    <![CDATA[
	    DELETE FROM availability
	    WHERE availability_id = #{availabilityId}
	    ]]>
	</delete>

	<!-- 7) 근무시간 삭제(특정 날짜 + 여러 시간 동시, HOUR 기준) -->
	<delete id="deleteAvailabilityByDateHours" parameterType="map">
	    <![CDATA[
	    DELETE FROM availability
	    WHERE trainer_id = #{trainerId}
	      AND DATE(available_datetime) = #{workDate}
	      AND HOUR(available_datetime) IN
	    ]]>
			<foreach collection="hours" item="h" open="(" close=")" separator=",">
	      <![CDATA[#{h}]]>
			</foreach>
	</delete>

	<!-- 8) 근무시간 삭제(특정 일자 시각목록; 예약 없는 슬롯만) -->
	<delete id="deleteAvailabilityByDatetimes" parameterType="map">
	    <![CDATA[
	    DELETE a
	    FROM availability a
	    LEFT JOIN reservation r ON r.availability_id = a.availability_id
	    WHERE a.trainer_id = #{trainerId}
	      AND a.available_datetime IN
	    ]]>
			<foreach collection="datetimes" item="dt" open="(" separator="," close=")">
	      <![CDATA[#{dt}]]>
			</foreach>
	    <![CDATA[
	      AND r.reservation_id IS NULL
	    ]]>
	</delete>

	<!-- 9) 회원관리 리스트 -->
	<select id="selectMemberManageList" parameterType="int" resultType="map">
		<![CDATA[
		SELECT
		  m.user_id   AS memberId,
		  m.user_name AS memberName,
		  m.birthdate,
		  p.job,
		  p.consult_date AS consultDate,
		  p.goal,
		  COALESCE(pc.total_sessions, 0)   AS totalSessions,
		  COALESCE(comp.completed_cnt, 0)  AS completedCount,
		  (COALESCE(pc.total_sessions,0) - COALESCE(comp.completed_cnt,0)) AS remainingCount
		FROM users m
		LEFT JOIN member_profile p ON p.member_id = m.user_id
		LEFT JOIN (
		  SELECT member_id, trainer_id, SUM(total_sessions) AS total_sessions
		  FROM pt_contract
		  GROUP BY member_id, trainer_id
		) pc   ON pc.member_id = m.user_id AND pc.trainer_id = #{trainerId}
		LEFT JOIN (
		  SELECT r2.member_id, a2.trainer_id, COUNT(*) AS completed_cnt
		  FROM reservation r2
		  JOIN availability a2 ON a2.availability_id = r2.availability_id
		  WHERE r2.status = 'COMPLETED'
		  GROUP BY r2.member_id, a2.trainer_id
		) comp ON comp.member_id = m.user_id AND comp.trainer_id = #{trainerId}
		WHERE m.assigned_trainer_id = #{trainerId}
		ORDER BY m.user_name
		]]>
	</select>
	
	<!-- 트레이너 강제예약 취소 -->
	<delete id="deleteReservationByTrainer" parameterType="map">
		<![CDATA[
		DELETE r
		FROM reservation r
		JOIN availability a ON a.availability_id = r.availability_id
		WHERE r.reservation_id = #{reservationId}
		  AND a.trainer_id    = #{trainerId}
		]]>
	</delete>
</mapper>
