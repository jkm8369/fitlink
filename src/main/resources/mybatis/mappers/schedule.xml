<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ⚠ namespace 문자열은 자바에서 그대로 사용할 거라 꼭 동일하게! -->
<mapper namespace="trainer.schedule">

	<select id="selectHoursByDate" resultType="int">
		SELECT work_hour
		FROM trainer_availability
		WHERE trainer_id = #{trainerId}
		AND work_date =
		#{workDate,jdbcType=DATE}
		ORDER BY work_hour
	</select>

	<delete id="deleteByDate">
		DELETE FROM trainer_availability
		WHERE trainer_id = #{trainerId}
		AND work_date = #{workDate,jdbcType=DATE}
	</delete>

	<insert id="insertHours">
		INSERT INTO trainer_availability (trainer_id, work_date, work_hour)
		VALUES
		<foreach collection="hours" item="h" separator=",">
			(#{trainerId}, #{workDate,jdbcType=DATE}, #{h,jdbcType=TINYINT})
		</foreach>
	</insert>

	<!-- 리스트 -->
	<select id="selectScheduleRowsForTrainer" parameterType="int" resultType="com.javaex.vo.ScheduleRowVO">
	  <![CDATA[
	    SELECT
	      r.reservation_id AS no,
	      DATE_FORMAT(TIMESTAMP(ta.work_date, MAKETIME(ta.work_hour, 0, 0)), '%Y.%m.%d') AS date,
	      DATE_FORMAT(TIMESTAMP(ta.work_date, MAKETIME(ta.work_hour, 0, 0)), '%H:%i')     AS time,
	      um.name AS name,
	      r.member_id AS memberId,
	      pm.total_sessions AS total,
	      (SELECT COUNT(*) FROM reservation
	         WHERE member_id = r.member_id
	           AND status IN ('BOOKED','ATTENDED')) AS used,
	      GREATEST(pm.total_sessions - (SELECT COUNT(*) FROM reservation
	         WHERE member_id = r.member_id
	           AND status IN ('BOOKED','ATTENDED')), 0) AS remain
	    FROM reservation r
	    JOIN trainer_availability ta ON ta.avail_id = r.availability_id
	    JOIN users um ON um.user_id = r.member_id
	    JOIN pt_member pm ON pm.member_id = r.member_id
	    WHERE ta.trainer_id = #{value}
	      AND r.status IN ('BOOKED','ATTENDED')
	    ORDER BY ta.work_date DESC, ta.work_hour DESC
	  ]]>
	</select>


</mapper>
